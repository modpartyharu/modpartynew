<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>대시보드</title>
</head>
<body>
    <h1 layout:fragment="page-title">대시보드</h1>

    <div layout:fragment="content">
        <div class="space-y-6">
            <!-- 인증되지 않은 경우 -->
            <div th:if="${selectedStore == null}" class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">대시보드를 사용하려면 로그인이 필요합니다</h3>
                <p class="text-gray-500 mb-6">Imweb OAuth를 통해 스토어를 연동해주세요.</p>
                <a href="/auth/login" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                    </svg>
                    스토어 연동하기
                </a>
            </div>

            <!-- 인증된 경우: 대시보드 표시 -->
            <div th:if="${selectedStore != null}">
                <!-- 일자별/지역별 집계 그리드 -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            일자별/지역별 참가 현황
                        </h3>
                        <!-- 기간 필터 -->
                        <form th:action="@{/}" method="get" class="flex items-center gap-2">
                            <select name="weeks" onchange="this.form.submit()"
                                    class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="1" th:selected="${selectedWeeks == 1}">향후 1주</option>
                                <option value="2" th:selected="${selectedWeeks == 2}">향후 2주</option>
                                <option value="3" th:selected="${selectedWeeks == 3}">향후 3주</option>
                                <option value="4" th:selected="${selectedWeeks == 4}">향후 4주</option>
                            </select>
                        </form>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">일자</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">지역</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-blue-600 uppercase tracking-wider bg-blue-50">남성총합</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-blue-600 uppercase tracking-wider bg-blue-50">남성확정자</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-blue-600 uppercase tracking-wider bg-blue-50">남성대기자</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-pink-600 uppercase tracking-wider bg-pink-50">여성총합</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-pink-600 uppercase tracking-wider bg-pink-50">여성확정자</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-pink-600 uppercase tracking-wider bg-pink-50">여성대기자</th>
                                </tr>
                            </thead>
                            <tbody id="aggregationBody" class="divide-y divide-gray-200">
                                <!-- JavaScript에서 행 머지 처리 -->
                            </tbody>
                        </table>
                        <div th:if="${#lists.isEmpty(aggregationData)}" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <p>해당 기간에 예정된 파티가 없습니다.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <script th:if="${selectedStore != null}" th:inline="javascript">
            /*<![CDATA[*/
            const aggregationData = /*[[${aggregationData}]]*/ [];
            /*]]>*/

            document.addEventListener('DOMContentLoaded', function() {
                renderAggregationTable(aggregationData);
            });

            function renderAggregationTable(data) {
                const tbody = document.getElementById('aggregationBody');
                if (!tbody || !data || data.length === 0) return;

                // 날짜별로 그룹화하여 rowspan 계산
                const dateGroups = {};
                data.forEach(row => {
                    const dateStr = row.event_date || '-';
                    if (!dateGroups[dateStr]) {
                        dateGroups[dateStr] = [];
                    }
                    dateGroups[dateStr].push(row);
                });

                let html = '';
                let isFirstDate = true;

                Object.keys(dateGroups).sort().forEach(dateStr => {
                    const rows = dateGroups[dateStr];
                    const rowspan = rows.length;

                    rows.forEach((row, idx) => {
                        const isFirstRow = idx === 0;
                        const bgClass = isFirstDate ? '' : 'bg-gray-50';

                        html += `<tr class="hover:bg-gray-100 transition-colors ${bgClass}">`;

                        // 일자 셀 (첫 번째 행에서만 표시, rowspan 적용)
                        if (isFirstRow) {
                            const formattedDate = formatDate(dateStr);
                            html += `<td class="px-4 py-3 text-sm font-medium text-gray-900 border-r border-gray-200" rowspan="${rowspan}">${formattedDate}</td>`;
                        }

                        // 지역
                        html += `<td class="px-4 py-3 text-sm text-gray-900">${row.region_name || '-'}</td>`;

                        // 남성 통계 (파란색 배경)
                        html += `<td class="px-4 py-3 text-sm text-center font-medium text-blue-700 bg-blue-50">${row.male_total || 0}</td>`;
                        html += `<td class="px-4 py-3 text-sm text-center text-blue-600 bg-blue-50">${row.male_confirmed || 0}</td>`;
                        html += `<td class="px-4 py-3 text-sm text-center text-blue-500 bg-blue-50">${row.male_waiting || 0}</td>`;

                        // 여성 통계 (분홍색 배경)
                        html += `<td class="px-4 py-3 text-sm text-center font-medium text-pink-700 bg-pink-50">${row.female_total || 0}</td>`;
                        html += `<td class="px-4 py-3 text-sm text-center text-pink-600 bg-pink-50">${row.female_confirmed || 0}</td>`;
                        html += `<td class="px-4 py-3 text-sm text-center text-pink-500 bg-pink-50">${row.female_waiting || 0}</td>`;

                        html += '</tr>';
                    });

                    isFirstDate = !isFirstDate;
                });

                tbody.innerHTML = html;
            }

            function formatDate(dateStr) {
                if (!dateStr || dateStr === '-') return '-';
                try {
                    const date = new Date(dateStr);
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
                    const weekday = weekdays[date.getDay()];
                    return `${month}/${day} (${weekday})`;
                } catch (e) {
                    return dateStr;
                }
            }
        </script>
    </th:block>
</body>
</html>
